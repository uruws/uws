upstream meteor-webcdn {
	random two least_conn;
	server meteor1.webcdn.svc.cluster.local:3000;
	server meteor2.webcdn.svc.cluster.local:3000;
	server meteor3.webcdn.svc.cluster.local:3000;
}

server {
	listen      443 ssl http2;
	listen [::]:443 ssl http2;

	server_name ${METEOR_HOST}.talkingpts.org;

	root /var/www/html;
	index index.html;

	include snippets/uws.conf;
	include snippets/uwslog-json-analytics.conf;

	include snippets/${METEOR_TLS}-tls.conf;

	set $upstream_name "meteor-webcdn";

	location / {
		root /var/cache/nginx.store;
		error_page 404 = @fetch;
	}

	location @fetch {
		internal;
		include snippets/proxy_params;
		proxy_cache_valid 1h;
		proxy_no_cache $arg_nocache;
		proxy_pass http://meteor-webcdn;
		proxy_store on;
		proxy_store_access user:rw group:rw all:r;
		proxy_temp_path /var/cache/nginx.temp;
		root /var/cache/nginx.store;
	}
}

#server {
#	listen      443 ssl http2;
#	listen [::]:443 ssl http2;
#
#	server_name ${METEOR_HOST}.talkingpts.org;
#
#	root /var/www/html;
#	index index.html;
#
#	include snippets/uws.conf;
#	include snippets/uwslog-json-analytics.conf;
#
#	include snippets/${METEOR_TLS}-tls.conf;
#
#	set $upstream_name "meteor-webcdn";
#
#	location / {
#		include snippets/proxy_params;
#		proxy_cache uwscache;
#		proxy_cache_valid 1h;
#		proxy_no_cache $arg_nocache;
#		proxy_pass http://meteor-webcdn;
#	}
#}
