FROM uws/base-2109

LABEL mantainer="Jerem√≠as Casteglione <jeremias@talkingpts.org>"
LABEL version="211006"

USER root:root
WORKDIR /root

ENV USER root
ENV HOME /root

RUN /root/bin/apt-install.sh munin-node psmisc procps munin-plugins-core munin-plugins-extra \
	&& rm -vf /etc/munin/plugins/*

ENV MN munin-contrib
ENV MR uruws/${MN}
ENV MV 22ba05175f518b67525883bd1864c90a68eb2e1e
RUN wget -O munin-contrib.tgz \
	https://github.com/${MR}/archive/${MV}.tar.gz \
	&& tar -xzf munin-contrib.tgz \
	&& rm -vf munin-contrib.tgz \
	&& mkdir -vp /uws/munin \
	&& mv -vf ${MN}-${MV} /uws/munin/contrib

# mongodb plugins deps
RUN /root/bin/apt-install.sh python3-pymongo

COPY ./utils /root/bin
RUN chmod -v 0750 /root/bin /root/bin/*.sh

COPY --chown=root:uws ./build/uwsbot-stats.bin /uws/bin/uwsbot-stats
RUN chmod -v 0750 /uws/bin/uwsbot-stats

COPY --chown=root:uws ./build/uwsbot-stats.env /uws/etc/env/bot/stats
RUN chmod -v 0640 /uws/etc/env/bot/stats

COPY --chown=root:uws ./build/uwsbot-plugin.conf /etc/munin/plugin-conf.d/uwsbot
RUN chmod -v 0640 /etc/munin/plugin-conf.d/uwsbot

COPY --chown=root:uws ./build/api-job-stats.bin /uws/bin/api-job-stats
RUN chmod -v 0750 /uws/bin/api-job-stats

COPY --chown=root:uws ./plugins/bin/mnpl.sh /uws/bin/mnpl.sh
COPY --chown=root:uws ./plugins/lib /uws/lib/plugins
RUN chmod -v 0750 /uws/bin/mnpl.sh

USER root:uws
WORKDIR /root

RUN python3 -m compileall -q /uws/lib/plugins

USER root:root
WORKDIR /root

ENV USER root
ENV HOME /root

ENTRYPOINT exec /root/bin/mn-start.sh
