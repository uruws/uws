---
- name: dir setup
  become: yes
  file:
    state: directory
    path: "{{ item }}"
    mode: '0751'
    owner: root
    group: root
  loop:
    - /srv/acme
    - /srv/acme/bin
    - /srv/acme/etc
    - /srv/run/acme
  tags:
    - acme

- name: cert dirs
  become: yes
  file:
    state: directory
    path: "{{ item }}"
    mode: '0770'
    owner: root
    group: uws
  loop:
    - /srv/acme/key
    - /srv/acme/req
  tags:
    - acme

- name: challenges dir
  become: yes
  file:
    state: directory
    path: /srv/run/acme/challenge
    mode: '0750'
    owner: uws
    group: www-data
  tags:
    - acme

- name: docker image
  docker_image:
    repository: uwsops/acme
    name: "{{ uwsops_ecr }}:acme"
    source: pull
    force_source: yes
  tags:
    - acme
    - docker

- name: scripts
  become: yes
  copy:
    src: ~/srv/acme/bin/{{ item }}
    dest: /srv/acme/bin/{{ item }}
    mode: '0550'
    owner: root
    group: uws
  loop:
    - acme-certs.sh
    - acme-cmd.sh
  tags:
    - acme

- name: cron job
  become: yes
  cron:
    cron_file: uws-acme
    name: acme-certs
    user: uws
    job: /srv/acme/bin/acme-certs.sh
    minute: "17"
    hour: "3"
    day: "3,18"
  tags:
    - acme

- name: get certs
  become: yes
  become_user: uws
  command: /srv/acme/bin/acme-certs.sh
  tags:
    - acme
