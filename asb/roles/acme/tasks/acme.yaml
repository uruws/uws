---
- name: Acme dir setup
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    mode: '0751'
    owner: root
    group: "{{ ansible_user }}"
  loop:
    - /srv/acme
    - /srv/acme/bin
    - /srv/acme/etc
    - /srv/acme/run
  tags:
    - acme

- name: Acme cert dirs
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    mode: '0770'
    owner: root
    group: uws
  loop:
    - /srv/acme/cert
    - /srv/acme/key
    - /srv/acme/req
  tags:
    - acme

- name: Acme account.key
  become: true
  ansible.builtin.copy:
    src: ~/secret/acme/{{ uws_acme_account }}
    dest: /srv/acme/key/account.key
    owner: uws
    group: uws
    mode: '0400'
  tags:
    - acme

- name: Acme run dirs
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    mode: '0770'
    owner: uws
    group: "{{ ansible_user }}"
  loop:
    - /srv/acme/run/tmp
  tags:
    - acme

- name: Acme challenges dir
  become: true
  ansible.builtin.file:
    state: directory
    path: /srv/acme/run/challenge
    mode: '0750'
    owner: uws
    group: www-data
  tags:
    - acme

- name: Acme scripts
  become: true
  ansible.builtin.copy:
    src: ~/srv/acme/bin/{{ item }}
    dest: /srv/acme/bin/{{ item }}
    mode: '0550'
    owner: root
    group: "{{ ansible_user }}"
  loop:
    - acme-certs.sh
    - acme-cmd.sh
    - acme-docker-image.sh
    - acme-reload.sh
  tags:
    - acme

- name: Acme cron job
  become: true
  ansible.builtin.cron:
    cron_file: uws-acme
    name: acme-certs
    user: uws
    job: /srv/acme/bin/acme-certs.sh
    minute: "17"
    hour: "3"
    day: "3,18"
  tags:
    - acme

- name: Acme reload cron job
  become: true
  ansible.builtin.cron:
    cron_file: uws-acme-reload
    name: acme-reload
    user: root
    job: /srv/acme/bin/acme-reload.sh
    minute: "20"
    hour: "4"
    day: "3,18"
  tags:
    - acme

- name: Acme certs.list
  become: true
  ansible.builtin.template:
    src: acme/certs.list
    dest: /srv/acme/etc/certs.list
    owner: root
    group: "{{ ansible_user }}"
    mode: '0440'
  when: uws_acme_certs
  tags:
    - acme
    - acme-certs

- name: Acme get docker image
  ansible.builtin.command: /srv/acme/bin/acme-docker-image.sh
  tags:
    - acme
    - acme-certs

- name: Acme get certs
  become: true
  become_user: uws
  ansible.builtin.command: /srv/acme/bin/acme-certs.sh
  tags:
    - acme
    - acme-certs
