---
- name: NginxTLS cache setup
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ nginx_cache_dir }}"
  tags:
    - nginx
    - nginx_tls

- name: NginxTLS uws cache setup
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: '0750'
  loop:
    - "{{ nginx_cache_dir }}/uws"
  tags:
    - nginx
    - nginx_tls

- name: NginxTLS config
  become: true
  ansible.builtin.template:
    src: conf/{{ item }}.conf
    dest: /etc/nginx/conf.d/zzzuws_{{ item }}.conf
    mode: '0644'
    owner: root
    group: root
  loop:
    - tls
  notify:
    - Nginx reload
  tags:
    - nginx
    - nginx_tls

- name: NginxTLS snippets
  become: true
  ansible.builtin.template:
    src: snippets/{{ item }}.conf
    dest: /etc/nginx/snippets/uws_{{ item }}.conf
    mode: '0644'
    owner: root
    group: root
  loop:
    - cache
    - cache-setup
    - ssl
    - ssl-verify-client
    - munin
    - monit
  notify:
    - Nginx reload
  tags:
    - nginx
    - nginx_tls

- name: NginxTLS default server
  become: true
  ansible.builtin.template:
    src: nginx/default_tls.conf
    dest: /etc/nginx/sites-enabled/default_tls
    mode: '0644'
    owner: root
    group: root
  notify:
    - Nginx reload
  tags:
    - nginx
    - nginx_tls

- name: NginxTLS sites enable
  become: true
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/nginx/sites-enabled/{{ item | basename }}"
    mode: '0644'
    owner: root
    group: root
  loop: "{{ nginx_tls_site }}"
  notify:
    - Nginx reload
  tags:
    - nginx
    - nginx_tls
