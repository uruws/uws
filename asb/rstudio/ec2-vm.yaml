---
- name: RStudio ec2 vm
  hosts: rstudio
  gather_facts: false
  tasks:

    - name: RStudio vm create
      delegate_to: localhost
      amazon.aws.ec2_instance:
        key_name: asbhost-rstudio
        network:
          groups:
            - rstudio-sg
        iam_instance_profile: EC2InstanceRole
        detailed_monitoring: false
        termination_protection: true
        instance_initiated_shutdown_behavior: stop
        ebs_optimized: false
        volumes:
          - device_name: /dev/xvda
            volume_type: gp2
            volume_size: 20
            delete_on_termination: true
            encrypted: true
        image_id: "{{ debian_ami }}"
        instance_type: "{{ vm_type }}"
        tags:
          Name: "{{ inventory_hostname }}"
        exact_count: 1
        vpc_subnet_id: "{{ vm_subnet }}"
      register: rstudio_vm

    - name: RStudio vm rootfs tag
      delegate_to: localhost
      amazon.aws.ec2_vol:
        state: present
        id: "{{ item['block_device_mapping'][item.root_device_name]['volume_id'] }}"
        zone: "{{ item.placement }}"
        name: "{{ inventory_hostname }}-rootfs"
        tags:
          Name: "{{ inventory_hostname }}-rootfs"
      loop: "{{ rstudio_vm.tagged_instances }}"
