---
- name: kali ec2 vm start
  hosts: ec2vm
  gather_facts: false
  tasks:

    - name: kali vm stopped
      delegate_to: localhost
      ec2_instance_info:
        filters:
          "tag:Name": "{{ inventory_hostname }}"
          instance-state-name: stopped
      register: kali_vm

    - name: kali vm start
      delegate_to: localhost
      ec2_instance:
        state: running
        wait: yes
        wait_timeout: 600
        instance_ids: "{{ item.instance_id }}"
      loop: "{{ kali_vm.instances }}"
      when: kali_vm.instances
