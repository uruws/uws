---
- name: Kali ec2 vm start
  hosts: ec2vm
  gather_facts: false
  tasks:

    - name: Kali vm stopped
      delegate_to: localhost
      amazon.aws.ec2_instance_info:
        filters:
          "tag:Name": "{{ inventory_hostname }}"
          instance-state-name: stopped
      register: kali_vm

    - name: Kali vm start
      delegate_to: localhost
      amazon.aws.ec2_instance:
        state: running
        wait: true
        wait_timeout: 600
        instance_ids: "{{ item.instance_id }}"
      loop: "{{ kali_vm.instances }}"
      when: kali_vm.instances
