#!/bin/sh
set -eu

umask 0027

# sudoers

sudoers=/etc/sudoers.d/99-uwscli
if test -s ${sudoers}; then
	chmod -v 0640 ${sudoers}
	chown -v root:root ${sudoers}
fi

# run dirs

install -v -d -o uws -g uwscli -m 0750 /run/uwscli
install -v -d -o uws -g uwscli -m 0770 /run/uwscli/nq
install -v -d -o uws -g uwscli -m 0770 /run/uwscli/build
install -v -d -o uws -g uwscli -m 0770 /run/uwscli/logs

# utils access

chmod -v 0750 ~uwscli
chown -v uwscli:uwscli ~uwscli

chmod -v 0750 ~uwscli/etc
chown -vR root:uwscli ~uwscli/etc

chmod -v 0750 ~uwscli/lib
chown -vR root:uwscli ~uwscli/lib

chmod -v 0750 ~uwscli/vendor
chown -vR root:uwscli ~uwscli/vendor

chmod -v 0550 ~uwscli/bin/*
chmod -v 0750 ~uwscli/bin
chown -vR root:uwscli ~uwscli/bin

adduser uws uwscli

# ops utils

addgroup uwsops || true

chown -v root:uwsops ~uwscli/bin/app-deploy
chown -v root:uwsops ~uwscli/bin/app-rollin
chown -v root:uwsops ~uwscli/bin/app-scale

# internal utils

chown -v uwscli:root ~uwscli/bin/app-autobuild

# python compile lib and vendor

umask 0022

rm -vrf ~uwscli/lib/__pycache__
python3 -m compileall ~uwscli/lib
chown -R root:uwscli ~uwscli/lib/__pycache__

find ~uwscli/vendor/ -type d -name __pycache__ | xargs rm -rf
python3 -m compileall ~uwscli/vendor
find ~uwscli/vendor/ -type d -name __pycache__ | xargs chown -R root:uwscli

umask 0027

# users profile

chmod -v 0750 ~antonio
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~antonio/.bash_profile

chmod -v 0750 ~aram
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~aram/.bash_profile

chmod -v 0750 ~gabriel
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~gabriel/.bash_profile

chmod -v 0750 ~guillermo
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~guillermo/.bash_profile

chmod -v 0750 ~jeremias
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~jeremias/.bash_profile

chmod -v 0750 ~nelson
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~nelson/.bash_profile

chmod -v 0750 ~ramiro
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~ramiro/.bash_profile

# admin users

addgroup uwsadm || true

adduser uwscli   uwsadm
adduser aram     uwsadm
adduser jeremias uwsadm

# ops users

adduser uwscli   uwsops
adduser aram     uwsops
adduser jeremias uwsops

# app groups

# app
addgroup uwsapp_app || true

adduser gabriel uwsapp_app
adduser nelson  uwsapp_app

# apptest
addgroup uwsapp_apptest || true

# cs
addgroup uwsapp_cs || true

# nlp
addgroup uwsapp_nlp || true

adduser guillermo uwsapp_nlp

# install crontab

crontab -u uwscli ~uwscli/etc/crontab.in

exit 0
