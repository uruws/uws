#!/bin/sh
set -eu

umask 0027

# sudoers

sudoers=/etc/sudoers.d/99-uwscli
if test -s ${sudoers}; then
	chmod -v 0640 ${sudoers}
	chown -v root:root ${sudoers}
fi

# run dirs

/uws/bin/uwscli-rundir.sh

# deploy script

chown -v root:uws /uws/bin/uwscli-deploy.sh
chmod -v 0750 /uws/bin/uwscli-deploy.sh

# utils access

chmod -v 0750 ~uwscli
chown -v uwscli:uwscli ~uwscli

chmod -v 0750 ~uwscli/etc
chown -vR root:uwscli ~uwscli/etc

chmod -v 0750 ~uwscli/lib
chown -vR root:uwscli ~uwscli/lib

chmod -v 0750 ~uwscli/vendor
chown -vR root:uwscli ~uwscli/vendor

chmod -v 0550 ~uwscli/bin/*
chmod -v 0750 ~uwscli/bin
chown -vR root:uwscli ~uwscli/bin

adduser uws uwscli

# operator utils

addgroup uwsops || true

chown -v root:uwsops ~uwscli/bin/app-deploy
chown -v root:uwsops ~uwscli/bin/app-restart
chown -v root:uwsops ~uwscli/bin/app-rollin
chown -v root:uwsops ~uwscli/bin/app-scale

# internal utils

chown -v uwscli:uws ~uwscli/bin/app-autobuild

# python compile lib and vendor

umask 0022

rm -vrf ~uwscli/lib/__pycache__
python3 -m compileall ~uwscli/lib
chown -R root:uwscli ~uwscli/lib/__pycache__

find ~uwscli/vendor/ -type d -name __pycache__ | xargs rm -rf
python3 -m compileall ~uwscli/vendor
find ~uwscli/vendor/ -type d -name __pycache__ | xargs chown -R root:uwscli

umask 0027

# users profile

chmod -v 0750 ~antonio
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~antonio/.bash_profile

chmod -v 0750 ~aram
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~aram/.bash_profile

chmod -v 0750 ~gabriel
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~gabriel/.bash_profile

chmod -v 0750 ~guillermo
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~guillermo/.bash_profile

chmod -v 0750 ~jeremias
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~jeremias/.bash_profile

chmod -v 0750 ~nelson
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~nelson/.bash_profile

chmod -v 0750 ~ramiro
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~ramiro/.bash_profile

# admin users

addgroup uwsadm || true

# Make uws user an admin. Needed for autobuild deploys.
adduser uws uwsadm

adduser uwscli   uwsadm
adduser aram     uwsadm
adduser jeremias uwsadm

# operator users

# Make uws user an operator. Needed for autobuild deploys.
adduser uws uwsops

adduser uwscli    uwsops
adduser aram      uwsops
adduser gabriel   uwsops
adduser guillermo uwsops
adduser jeremias  uwsops
adduser nelson    uwsops

# app groups

# app
addgroup uwsapp_app || true

adduser antonio uwsapp_app
adduser gabriel uwsapp_app
adduser nelson  uwsapp_app
adduser ramiro  uwsapp_app

# apptest
addgroup uwsapp_apptest || true

adduser gabriel uwsapp_apptest
adduser ramiro  uwsapp_apptest

# beta
addgroup uwsapp_beta || true

adduser gabriel uwsapp_beta

# cs
addgroup uwsapp_crowdsourcing || true
addgroup uwsapp_cs || true

adduser gabriel uwsapp_crowdsourcing
adduser gabriel uwsapp_cs
adduser ramiro  uwsapp_cs

# nlp
addgroup uwsapp_nlpsvc || true
addgroup uwsapp_nlp || true

adduser guillermo uwsapp_nlpsvc
adduser guillermo uwsapp_nlp
adduser ramiro    uwsapp_nlp

# infraui
addgroup uwsapp_infra-ui || true

adduser gabriel uwsapp_infra-ui

# install crontab

crontab -u uwscli ~uwscli/etc/crontab.in

# remove old users

deluser --remove-home alejandro || true

# uwscli setup

# env dirs
install -v -d -o root -g uws -m 0750 /srv/uwscli
install -v -d -o root -g uws -m 0770 /srv/uwscli/logs

# systemd service
install -v -C -o root -g root -m 0640 /srv/uws/deploy/cli/schroot/uwscli-@.service \
	/etc/systemd/system/uwscli-@.service

exit 0
