#!/bin/sh
set -eu

umask 0027

#
# sudoers
#

install -v -C -m 0640 -o root -g root ~uwscli/etc/sudoers.d/99-uwscli /etc/sudoers.d/99-uwscli

#
# run dirs
#

/uws/bin/uwscli-rundir.sh

#
# utils access
#

chmod -v 0750 ~uwscli
chown -v uwscli:uwscli ~uwscli

chmod -v  0750        ~uwscli/etc
chown -vR root:uwscli ~uwscli/etc

chmod -v  0750        ~uwscli/lib
chown -vR root:uwscli ~uwscli/lib

chmod -v  0750        ~uwscli/vendor
chown -vR root:uwscli ~uwscli/vendor

chmod -v  0550        ~uwscli/bin/*
chmod -v  0750        ~uwscli/bin
chown -vR root:uwscli ~uwscli/bin

adduser uws uwscli

#
# operator utils
#

addgroup uwsops || true

chown -v root:uwsops ~uwscli/bin/app-deploy
chown -v root:uwsops ~uwscli/bin/app-restart
chown -v root:uwsops ~uwscli/bin/app-rollin
chown -v root:uwsops ~uwscli/bin/app-scale

#
# operator proxy utils
#

chown -v root:uwsops ~uwscli/bin/proxy-*

#
# operator custom utils
#

chown -v root:uwsops ~uwscli/bin/production-*
chown -v root:uwsops ~uwscli/bin/staging-*

#
# internal utils
#

chown -v uwscli:uws ~uwscli/bin/app-autobuild

#
# python compile lib and vendor
#

umask 0022

rm -vrf ~uwscli/lib/__pycache__
python3 -m compileall ~uwscli/lib
chown -R root:uwscli ~uwscli/lib/__pycache__

find ~uwscli/vendor/ -type d -name __pycache__ | xargs rm -rf
python3 -m compileall ~uwscli/vendor
find ~uwscli/vendor/ -type d -name __pycache__ | xargs chown -R root:uwscli

umask 0027

#
# users profile
#

chmod -v 0750 ~antonio
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~antonio/.bash_profile

chmod -v 0750 ~aram
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~aram/.bash_profile

chmod -v 0750 ~gabriel
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~gabriel/.bash_profile

chmod -v 0750 ~guillermo
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~guillermo/.bash_profile

chmod -v 0750 ~jeremias
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~jeremias/.bash_profile

chmod -v 0750 ~nelson
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~nelson/.bash_profile

chmod -v 0750 ~ramiro
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~ramiro/.bash_profile

chmod -v 0750 ~uwscbdev
install -v -C -m 0644 ~uwscli/etc/user.bash_profile ~uwscbdev/.bash_profile
install -v -d -m 0750 -o uwscbdev -g uwscbdev ~uwscbdev/.ssh
install -v -C -m 0600 -o uwscbdev -g uwscbdev /srv/uws/deploy/secret/webapp/chatbot/ssh/ecdsa_id.pub ~uwscbdev/.ssh/authorized_keys

#
# admin users
#

addgroup uwsadm || true

# Make uws user an admin. Needed for autobuild deploys.
adduser uws uwsadm

adduser uwscli   uwsadm
adduser aram     uwsadm
adduser jeremias uwsadm

#
# operator users
#

# Make uws user an operator. Needed for autobuild deploys.
adduser uws uwsops

adduser uwscli    uwsops
adduser aram      uwsops
adduser gabriel   uwsops
adduser guillermo uwsops
adduser jeremias  uwsops
adduser nelson    uwsops
adduser uwscbdev  uwsops

#
# app groups
#

# app
addgroup uwsapp_app || true

adduser antonio uwsapp_app
adduser gabriel uwsapp_app
adduser nelson  uwsapp_app
adduser ramiro  uwsapp_app

# apptest
addgroup uwsapp_apptest || true

adduser gabriel  uwsapp_apptest
adduser ramiro   uwsapp_apptest
adduser uwscbdev uwsapp_apptest

# beta
addgroup uwsapp_beta || true

adduser gabriel uwsapp_beta

# cs
addgroup uwsapp_crowdsourcing || true
addgroup uwsapp_cs || true

adduser gabriel uwsapp_crowdsourcing
adduser gabriel uwsapp_cs
adduser ramiro  uwsapp_cs

# infraui
addgroup uwsapp_infra-ui || true

adduser gabriel uwsapp_infra-ui

# uwsapp_meteor-vanilla
addgroup uwsapp_meteor-vanilla || true

adduser uwscbdev uwsapp_meteor-vanilla

#
# install crontab
#

crontab -u uwscli ~uwscli/etc/crontab.in

#
# remove old users
#

#~ deluser --remove-home alejandro || true

# deprecate uwscli schroot setup
rm -vf /etc/systemd/system/uwscli-@.service
rm -vf /srv/home/uwscli/sbin/*_init.sh
rm -vf /uws/bin/uwscli-deploy.sh
rm -vf /srv/home/uwscli/bin/uwspass
rm -vf /srv/home/uwscli/bin/production-tapo-*
rm -vf /srv/home/uwscli/bin/staging-tapo-*

exit 0
