#!/bin/sh
set -eu

case $1 in
	-h|--help)
		exec uwshelp meteor-build
	;;
esac

src='app/src'
target='app'
if test "X${1}" = 'X--app'; then
	shift
elif test "X${1}" = 'X--beta'; then
	shift
	target="beta"
elif test "X${1}" = 'X--cs'; then
	shift
	src='cs/src'
	target='crowdsourcing'
fi

test_flags=""
if test "X${1}" = 'X--no-test'; then
	shift
	test_flags='--no-test'
fi

release=${1:?'app release?'}

uwsnq /srv/deploy/Buildpack/build.py --src ${src} --target ${target} \
	${release} -- ${test_flags}

echo ''
echo 'Check build job with: uwsq'
echo ''
echo 'Deploy and check status with:'
echo ''
echo "  Workers: worker-deploy ${release}"
echo '           worker-status'
echo ''
echo "  Web: web-deploy (east|west) ${release}"
echo '       web-status (east|west)'
echo ''
echo "  Beta: beta-deploy ${release}"
echo '        beta-status'
echo ''
echo "  Crowdsourcing: cs-deploy ${release}"
echo '                 cs-status'
echo ''
echo 'Run uwshelp for more information.'
echo ''

exit 0

#uwscli:meteor-build			- build meteor app version/tag

#uwsdoc:meteor-build [--app|--beta|--cs] [--no-test] X.Y.Z
#uwsdoc:
#uwsdoc:Build meteor app from X.Y.Z release.
#uwsdoc:
#uwsdoc:  --app     - App release (default).
#uwsdoc:  --beta    - App beta release.
#uwsdoc:  --cs      - Crowdsourcing release.
#uwsdoc:  --no-test - do not run app tests.
