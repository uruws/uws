#!/bin/sh
set -eu

mkdir -vp /srv/cache/nginx/uws
chown -v www-data:www-data /srv/cache/nginx/uws
chmod -v 0750 /srv/cache/nginx/uws

chown -v www-data:www-data /srv/cache/nginx
chmod -v 0750 /srv/cache/nginx

install -v -d -o www-data -g www-data -m 0750 /srv/cache/nginx/temp
install -v -d -o www-data -g www-data -m 0750 /srv/cache/nginx/data
install -v -d -o www-data -g www-data -m 0750 /srv/cache/nginx/data/img
install -v -d -o www-data -g www-data -m 0750 /srv/cache/nginx/data/webfonts
install -v -d -o www-data -g www-data -m 0750 /srv/cache/nginx/data/scripts

chown -vR root:www-data /var/www
chmod -v 0640 /var/www/html/index.html

rm -vf /etc/nginx/sites-enabled/*

install -v /etc/nginx/sites-available/janis /etc/nginx/sites-enabled

mkdir -vp /srv/etc/ssl
dhparam=/srv/etc/ssl/dhparam.pem
if ! test -s ${dhparam}; then
	openssl dhparam -out ${dhparam} 4096
fi

if test -s /srv/acme/cert/janis.uws.talkingpts.org.crt; then
	install -v /etc/nginx/sites-available/ssl-janis /etc/nginx/sites-enabled
fi

# staging-heroku
install -v /etc/nginx/sites-available/staging-heroku /etc/nginx/sites-enabled
if test -s /srv/acme/cert/staging-heroku.uws.talkingpts.org.crt; then
	install -v /etc/nginx/sites-available/ssl-staging-heroku /etc/nginx/sites-enabled
fi

exit 0
