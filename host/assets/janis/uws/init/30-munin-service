#!/bin/sh
set -eu

install -v -d -o root -g uws -m 0750 /srv/etc/munin
install -v -d -o root -g uws -m 0751 /srv/munin
install -v -d -o root -g uws -m 0751 /uws/munin

chown -v root:uws /uws/munin/*.sh
chmod -v 0750 /uws/munin/*.sh

cd /srv/uws/deploy
sudo -n -u uws make munin
cd -

if ! systemctl is-enabled uws-munin.service; then
	systemctl enable uws-munin.service
	systemctl start uws-munin
fi

install -v -o root -g root -m 0640 \
	/etc/munin/plugin-conf.d/mongodb

export DOCKER_IMAGE='uws/munin-2203'

/uws/bin/service-restart.sh uws-munin \
	/uws/munin/service-start.sh \
	/srv/etc/munin \
	/srv/uws/deploy/secret/eks/files/munin

exit 0
