#
# staging-heroku SSL internal domain
#

# Heroku docs:
#https://help.heroku.com/YTWRHLVH/how-do-i-make-my-nginx-proxy-connect-to-a-heroku-app-behind-heroku-ssl

# SNI
proxy_ssl_server_name on;

upstream tapostagingapi {
	server janisapi-upstream.uws.talkingpts.org:443;
}

upstream tapostagingweb {
	server janisweb-upstream.uws.talkingpts.org:443;
}

map $http_upgrade $connection_upgrade {
	default upgrade;
	'' close;
}

server {
	listen 443 ssl;
	listen [::]:443 ssl;

	server_name staging-heroku.uws.talkingpts.org;
	server_tokens off;

	root /var/www/html;

	ssl_certificate /srv/acme/cert/staging-heroku.uws.talkingpts.org.crt;
	ssl_certificate_key /srv/acme/key/staging-heroku.uws.talkingpts.org.key;

	include /srv/etc/nginx/ssl.conf;

	# api

	location /api/ {
		set $upstream tapostagingapi;
		proxy_pass https://$upstream;
		proxy_ssl_name janisapi-upstream.uws.talkingpts.org;
		proxy_set_header x-forwarded-host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host janisapi-upstream.uws.talkingpts.org;
	}

	# websocket

	location /websocket {
		set $upstream tapostagingweb;
		proxy_pass https://$upstream;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
		proxy_ssl_name janisweb-upstream.uws.talkingpts.org;
		proxy_set_header x-forwarded-host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host janisweb-upstream.uws.talkingpts.org;
	}

	# cache files

	location /img/ {
		root /srv/cache/nginx/data;
		error_page 404 = @fetch;
	}

	location /scripts/ {
		root /srv/cache/nginx/data;
		error_page 404 = @fetch;
	}

	location /webfonts/ {
		root /srv/cache/nginx/data;
		error_page 404 = @fetch;
	}

	location @fetch {
		internal;
		set $upstream tapostagingweb;
		proxy_pass https://$upstream;
		proxy_ssl_name janisweb-upstream.uws.talkingpts.org;
		proxy_set_header x-forwarded-host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host janisweb-upstream.uws.talkingpts.org;
		proxy_store on;
		proxy_store_access user:rw group:rw all:r;
		proxy_temp_path /srv/cache/nginx/temp;
		proxy_cache_valid 1h;
		root /srv/cache/nginx/data;
	}

	# web

	location / {
		set $upstream tapostagingweb;
		proxy_pass https://$upstream;
		proxy_ssl_name janisweb-upstream.uws.talkingpts.org;
		proxy_set_header x-forwarded-host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host janisweb-upstream.uws.talkingpts.org;
	}
}
