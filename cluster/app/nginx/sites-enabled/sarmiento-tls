upstream meteor-api {
	server meteor.api:3000;
}

upstream meteor-web {
	ip_hash;
	server meteor.web:3000;
}

server {
	listen 443 ssl;
	listen [::]:443 ssl;

	server_name sarmiento.uws.talkingpts.org;

	include snippets/uws.conf;
	include snippets/tapo-tls.conf;

	access_log /var/log/nginx/access_log upstream;
	error_log  /var/log/nginx/error_log;

	root /var/www/html;
	index index.html;

	location ~* "^/(websocket)$" {
		include proxy_params;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;
		rewrite "(?i)/(websocket)$" /$1 break;
		proxy_pass http://meteor-web;
	}

	location ~* "^/(api/.*)" {
		include proxy_params;
		rewrite "(?i)/(api/.*)" /$1 break;
		proxy_pass http://meteor-api;
	}

	location ~* "^/(.*)" {
		include proxy_params;
		rewrite "(?i)/(.*)" /$1 break;
		proxy_pass http://meteor-web;
	}
}
