#!/bin/sh
set -eu

# shellcheck source=/home/uws/secret/secret.env
. ~/secret/secret.env

uwseks utils enable-secrets-encryption -v5 \
	--encrypt-existing-secrets=true \
	--key-arn "arn:aws:kms:${AWS_REGION}:${AWS_ACCOUNT_ID}:key/mrk-61a255eb5e1846d99a9763bca04b1c5d"

# aws users auth
uwskube apply -f ~/secret/aws-auth.yaml

# cluster autoscaler
# https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html

uwseks utils associate-iam-oidc-provider --approve

uwseks create iamserviceaccount \
	--namespace=kube-system \
	--name=cluster-autoscaler \
	--override-existing-serviceaccounts \
	--attach-policy-arn="arn:aws:iam::${AWS_ACCOUNT_ID}:policy/eksClusterAutoscaler" \
	--approve

~/k8s/csi-driver/setup.sh
~/k8s/autoscaler/setup.sh
~/k8s/metrics-server/setup.sh
#~/k8s/efs/setup.sh
~/k8s/mon/setup.sh
~/k8s/gateway/setup.sh

~/k8s/gateway/status.sh
exit 0
